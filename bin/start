#!/usr/bin/env bash

# shellcheck disable=SC2129
# shellcheck disable=SC2153

set -e

script_dir="$(dirname "$(readlink -f "$0")")"
project_dir="$(realpath "${script_dir}/..")"

cd "${project_dir}" || exit 1

# Load environment variables from .env file
source .env

# Create a temporary directory
HOME_ECOSYSTEM_TMP_DIR=$(mktemp -d)
export HOME_ECOSYSTEM_TMP_DIR

# Create directories for Postgres
mkdir -p "${HOME_ECOSYSTEM_VAR_DIR}/postgres/data"
mkdir -p "${HOME_ECOSYSTEM_VAR_DIR}/homebox/data"
mkdir -p "${HOME_ECOSYSTEM_TMP_DIR}/postgres-init"

# Create directories for Plex
mkdir -p "${HOME_ECOSYSTEM_PLEX_MEDIA_DIR}"
mkdir -p "${HOME_ECOSYSTEM_VAR_DIR}/plex/config"
mkdir -p "${HOME_ECOSYSTEM_VAR_DIR}/plex/transcode"

# Create directories for OpenSearch
mkdir -p "${HOME_ECOSYSTEM_VAR_DIR}/opensearch/data"

# Create directories for Nginx
mkdir -p "${HOME_ECOSYSTEM_VAR_DIR}/nginx/logs"

# Set execute permissions on scripts
chmod +x "${HOME_ECOSYSTEM_PROJECT_DIR}/bin/"*
chmod +x "${HOME_ECOSYSTEM_PROJECT_DIR}/apps/homebox/postgres-init/homebox.sh"

# Start the Docker containers
set -x
docker compose \
  --project-name "${HOME_ECOSYSTEM_PROJECT_NAME}" \
  --file "${HOME_ECOSYSTEM_PROJECT_DIR}/docker/docker-compose.yml" \
  --env-file "${HOME_ECOSYSTEM_PROJECT_DIR}/.env" \
  up \
  --detach \
  --force-recreate
{ set +x; } 2>/dev/null
